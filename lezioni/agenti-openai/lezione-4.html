<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lezione 4: Orchestrazione Single-Agent - AI Learning Hub</title>
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #ec4899;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --dark: #0f172a;
            --light: #f8fafc;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--dark);
            color: #e2e8f0;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Background Animation */
        .orchestration-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            opacity: 0.03;
            overflow: hidden;
        }

        .loop-icon {
            position: absolute;
            font-size: 3rem;
            animation: rotate 20s linear infinite;
        }

        .loop-icon:nth-child(1) {
            top: 10%;
            left: 10%;
            animation-duration: 25s;
        }

        .loop-icon:nth-child(2) {
            top: 20%;
            right: 15%;
            animation-duration: 30s;
            animation-direction: reverse;
        }

        .loop-icon:nth-child(3) {
            bottom: 20%;
            left: 20%;
            animation-duration: 35s;
        }

        .loop-icon:nth-child(4) {
            bottom: 10%;
            right: 10%;
            animation-duration: 28s;
            animation-direction: reverse;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Header */
        header {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        nav {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo span {
            font-size: 2rem;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
            align-items: center;
        }

        .nav-links a {
            color: #cbd5e1;
            text-decoration: none;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: var(--primary);
        }

        /* Main Content */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Lesson Header */
        .lesson-header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInDown 0.8s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .lesson-meta {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .lesson-header h1 {
            font-size: 3rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .lesson-subtitle {
            font-size: 1.2rem;
            color: #cbd5e1;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Progress Bar */
        .progress-container {
            background: rgba(99, 102, 241, 0.1);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 3rem;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            color: #94a3b8;
        }

        .progress-bar {
            background: rgba(99, 102, 241, 0.2);
            height: 10px;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            background: var(--gradient);
            height: 100%;
            width: 67%;
            transition: width 0.5s ease-out;
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }

        /* Content Sections */
        .content-section {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 20px;
            padding: 3rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(99, 102, 241, 0.2);
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-size: 2rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .section-icon {
            font-size: 2.5rem;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Run Loop Visualization */
        .run-loop-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 3rem;
            margin: 2rem 0;
            position: relative;
            overflow: hidden;
        }

        .run-loop-diagram {
            display: flex;
            justify-content: space-around;
            align-items: center;
            min-height: 300px;
            position: relative;
        }

        .loop-state {
            background: rgba(99, 102, 241, 0.2);
            border: 2px solid var(--primary);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 2;
        }

        .loop-state:hover {
            transform: scale(1.05);
            background: rgba(99, 102, 241, 0.3);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .loop-state.active {
            background: var(--gradient);
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        .state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .state-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .state-description {
            font-size: 0.9rem;
            color: #94a3b8;
        }

        .flow-arrow {
            position: absolute;
            width: 100px;
            height: 2px;
            background: var(--primary);
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
        }

        .flow-arrow::after {
            content: '';
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid var(--primary);
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
        }

        .flow-arrow.arrow-1 {
            left: 25%;
        }

        .flow-arrow.arrow-2 {
            left: 50%;
        }

        .flow-arrow.arrow-3 {
            left: 75%;
        }

        /* Exit Conditions Grid */
        .exit-conditions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .exit-condition-card {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 15px;
            padding: 2rem;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .exit-condition-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--gradient);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .exit-condition-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.2);
        }

        .exit-condition-card:hover::before {
            transform: scaleX(1);
        }

        .condition-type {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .condition-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .condition-description {
            color: #cbd5e1;
            font-size: 0.95rem;
            margin-bottom: 1rem;
        }

        .condition-example {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 10px;
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--accent);
        }

        /* Decision Matrix */
        .decision-matrix {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
            overflow-x: auto;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
        }

        .matrix-table th,
        .matrix-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
        }

        .matrix-table th {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
            font-weight: bold;
        }

        .matrix-table tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .complexity-low {
            color: var(--success);
        }

        .complexity-medium {
            color: var(--warning);
        }

        .complexity-high {
            color: var(--error);
        }

        /* State Diagram */
        .state-diagram {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 3rem;
            margin-top: 2rem;
            text-align: center;
        }

        .state-nodes {
            display: flex;
            justify-content: center;
            gap: 3rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }

        .state-node {
            background: rgba(99, 102, 241, 0.2);
            border: 2px solid var(--primary);
            border-radius: 50%;
            width: 120px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .state-node:hover {
            transform: scale(1.1);
            background: rgba(99, 102, 241, 0.3);
        }

        .state-node-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .state-node-label {
            font-size: 0.9rem;
            font-weight: bold;
        }

        /* Performance Dashboard */
        .performance-dashboard {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: rgba(99, 102, 241, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(99, 102, 241, 0.2);
            transition: all 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.2);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .metric-label {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .metric-chart {
            height: 100px;
            background: linear-gradient(to right, 
                rgba(99, 102, 241, 0.3) 0%, 
                rgba(99, 102, 241, 0.6) 50%, 
                rgba(16, 185, 129, 0.6) 100%);
            border-radius: 10px;
            margin-top: 1rem;
            position: relative;
            overflow: hidden;
        }

        .chart-line {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60%;
            background: rgba(255, 255, 255, 0.1);
            clip-path: polygon(
                0 100%, 
                20% 70%, 
                40% 80%, 
                60% 40%, 
                80% 50%, 
                100% 20%
            );
        }

        /* Interactive Lab */
        .flow-designer {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 2rem;
            margin-top: 2rem;
            min-height: 400px;
        }

        .designer-toolbar {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
        }

        .tool-item {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid var(--primary);
            border-radius: 10px;
            padding: 1rem;
            cursor: grab;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tool-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
        }

        .tool-item:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        .designer-canvas {
            background: rgba(99, 102, 241, 0.05);
            border: 2px dashed rgba(99, 102, 241, 0.3);
            border-radius: 15px;
            min-height: 300px;
            padding: 2rem;
            position: relative;
        }

        .canvas-placeholder {
            text-align: center;
            color: #64748b;
            font-size: 1.1rem;
            margin-top: 100px;
        }

        .dropped-component {
            background: var(--gradient);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin: 0.5rem;
            display: inline-block;
            animation: dropIn 0.3s ease-out;
        }

        @keyframes dropIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Guide Section */
        .guide-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(236, 72, 153, 0.1));
            border-radius: 20px;
            padding: 2rem;
            margin-top: 3rem;
            text-align: center;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .guide-section h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .guide-btn {
            display: inline-block;
            background: var(--gradient);
            color: white;
            padding: 1rem 2rem;
            border-radius: 30px;
            text-decoration: none;
            margin: 1rem 0;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .guide-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(99, 102, 241, 0.4);
        }

        .guide-btn.coming-soon {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .guide-note {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        /* Alerts */
        .alert {
            display: flex;
            gap: 1rem;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            align-items: flex-start;
        }

        .alert-info {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        /* Navigation */
        .lesson-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 4rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(99, 102, 241, 0.2);
        }

        .nav-btn {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
            padding: 1rem 2rem;
            border-radius: 15px;
            text-decoration: none;
            transition: all 0.3s;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .nav-btn:hover {
            background: rgba(99, 102, 241, 0.2);
            transform: translateX(-5px);
        }

        .nav-btn.next:hover {
            transform: translateX(5px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .lesson-header h1 {
                font-size: 2rem;
            }

            .content-section {
                padding: 1.5rem;
            }

            .run-loop-diagram {
                flex-direction: column;
                gap: 2rem;
            }

            .flow-arrow {
                display: none;
            }

            .exit-conditions-grid {
                grid-template-columns: 1fr;
            }

            .nav-links {
                gap: 1rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Background Animation -->
    <div class="orchestration-bg">
        <div class="loop-icon">🔄</div>
        <div class="loop-icon">⚡</div>
        <div class="loop-icon">🎯</div>
        <div class="loop-icon">🏁</div>
    </div>

    <!-- Header -->
    <header>
        <nav>
            <a href="../../index.html" class="logo">
                <span>🧠</span> AI Learning Hub
            </a>
            <ul class="nav-links">
                <li><a href="../../lezioni.html">← Tutte le Lezioni</a></li>
                <li><a href="../../guide.html">Guide</a></li>
                <li><a href="../../index.html">🏠 Home</a></li>
            </ul>
        </nav>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Lesson Header -->
        <div class="lesson-header">
            <div class="lesson-meta">
                📄 Fonte: OpenAI - A Practical Guide to Building Agents
            </div>
            <h1>Orchestrazione Single-Agent</h1>
            <p class="lesson-subtitle">
                Padroneggia l'arte di orchestrare agenti singoli con loop di esecuzione, exit conditions e template avanzati
            </p>
        </div>

        <!-- Progress -->
        <div class="progress-container">
            <div class="progress-header">
                <span>Lezione 4 di 6</span>
                <span>67% completato</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
        </div>

        <!-- Section 1: Anatomia del Run Loop -->
        <div class="content-section">
            <h2 class="section-title">
                <div class="section-icon">🔄</div>
                Anatomia del Run Loop
            </h2>

            <p style="font-size: 1.1rem; margin-bottom: 2rem; color: #cbd5e1;">
                Al cuore di ogni sistema di orchestrazione c'è il concetto di "run": un loop intelligente che permette 
                all'agente di operare autonomamente fino al raggiungimento di una condizione di uscita.
            </p>

            <div class="alert alert-info">
                <div style="font-size: 1.5rem;">💡</div>
                <div>
                    <strong>Concetto Chiave:</strong> Un "run" è essenzialmente un ciclo while intelligente 
                    che gestisce l'interazione tra l'LLM, i tools e le decisioni dell'agente.
                </div>
            </div>

            <div class="run-loop-container">
                <h3 style="text-align: center; margin-bottom: 2rem; color: var(--primary);">
                    Ciclo di Esecuzione Interattivo
                </h3>
                <div class="run-loop-diagram">
                    <div class="loop-state" onclick="activateState(this, 'ready')">
                        <div class="state-icon">🚀</div>
                        <div class="state-name">Ready</div>
                        <div class="state-description">Inizializzazione</div>
                    </div>
                    
                    <div class="flow-arrow arrow-1"></div>
                    
                    <div class="loop-state" onclick="activateState(this, 'running')">
                        <div class="state-icon">⚡</div>
                        <div class="state-name">Running</div>
                        <div class="state-description">Esecuzione task</div>
                    </div>
                    
                    <div class="flow-arrow arrow-2"></div>
                    
                    <div class="loop-state" onclick="activateState(this, 'waiting')">
                        <div class="state-icon">⏳</div>
                        <div class="state-name">Waiting</div>
                        <div class="state-description">Attesa risposta</div>
                    </div>
                    
                    <div class="flow-arrow arrow-3"></div>
                    
                    <div class="loop-state" onclick="activateState(this, 'complete')">
                        <div class="state-icon">✅</div>
                        <div class="state-name">Complete</div>
                        <div class="state-description">Task completato</div>
                    </div>
                </div>

                <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(99, 102, 241, 0.1); border-radius: 15px;">
                    <h4 style="color: var(--accent); margin-bottom: 1rem;">Gestione Memoria e Contesto</h4>
                    <p style="color: #cbd5e1;">
                        Durante ogni ciclo, il sistema mantiene:
                    </p>
                    <ul style="margin-top: 0.5rem; padding-left: 1.5rem; color: #cbd5e1;">
                        <li>📝 <strong>Message History:</strong> Conversazione completa con l'utente</li>
                        <li>🛠️ <strong>Tool Calls:</strong> Storico delle chiamate ai tools e risultati</li>
                        <li>💾 <strong>State Variables:</strong> Variabili di stato persistenti</li>
                        <li>🎯 <strong>Execution Context:</strong> Contesto attuale dell'esecuzione</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Section 2: Exit Conditions -->
        <div class="content-section">
            <h2 class="section-title">
                <div class="section-icon">🏁</div>
                Exit Conditions: Teoria e Patterns
            </h2>

            <p style="font-size: 1.1rem; margin-bottom: 2rem; color: #cbd5e1;">
                Le exit conditions determinano quando un agent deve terminare il suo ciclo di esecuzione. 
                Una corretta implementazione previene loop infiniti e garantisce risultati deterministici.
            </p>

            <div class="exit-conditions-grid">
                <div class="exit-condition-card" onclick="showExitDetail('deterministic')">
                    <div class="condition-type">🎯</div>
                    <h3 class="condition-title">Deterministiche</h3>
                    <p class="condition-description">
                        Condizioni predefinite e verificabili che garantiscono terminazione certa
                    </p>
                    <div class="condition-example">
                        if tool_name == "final_output"
                    </div>
                </div>

                <div class="exit-condition-card" onclick="showExitDetail('probabilistic')">
                    <div class="condition-type">🎲</div>
                    <h3 class="condition-title">Probabilistiche</h3>
                    <p class="condition-description">
                        Basate su confidence score o soglie di probabilità
                    </p>
                    <div class="condition-example">
                        if confidence > 0.95
                    </div>
                </div>

                <div class="exit-condition-card" onclick="showExitDetail('timeout')">
                    <div class="condition-type">⏱️</div>
                    <h3 class="condition-title">Timeout</h3>
                    <p class="condition-description">
                        Limiti temporali o di iterazioni per prevenire esecuzioni infinite
                    </p>
                    <div class="condition-example">
                        if iterations >= max_iter
                    </div>
                </div>

                <div class="exit-condition-card" onclick="showExitDetail('error')">
                    <div class="condition-type">⚠️</div>
                    <h3 class="condition-title">Error-based</h3>
                    <p class="condition-description">
                        Gestione di errori critici che richiedono terminazione immediata
                    </p>
                    <div class="condition-example">
                        if error.is_critical()
                    </div>
                </div>
            </div>

            <div style="margin-top: 2rem; padding: 2rem; background: rgba(16, 185, 129, 0.1); border-radius: 15px; border: 1px solid rgba(16, 185, 129, 0.3);">
                <h4 style="color: var(--success); margin-bottom: 1rem;">
                    🌳 Decision Tree Interattivo
                </h4>
                <p style="color: #cbd5e1; margin-bottom: 1rem;">
                    Clicca sui nodi per esplorare il processo decisionale:
                </p>
                <div id="decisionTree" style="text-align: center; padding: 2rem;">
                    <!-- Simplified visual representation -->
                    <div style="display: inline-block; background: var(--gradient); color: white; padding: 1rem 2rem; border-radius: 30px; cursor: pointer;" onclick="expandDecisionTree()">
                        Esplora Decision Tree →
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3: Template Systems vs Multi-Agent -->
        <div class="content-section">
            <h2 class="section-title">
                <div class="section-icon">⚖️</div>
                Template Systems vs Multi-Agent
            </h2>

            <p style="font-size: 1.1rem; margin-bottom: 2rem; color: #cbd5e1;">
                La scelta tra template dinamici e sistemi multi-agent dipende dalla complessità del task 
                e dai requisiti di manutenibilità del sistema.
            </p>

            <div class="decision-matrix">
                <h4 style="color: var(--primary); margin-bottom: 1.5rem;">Matrice Decisionale</h4>
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th>Criterio</th>
                            <th>Template Systems</th>
                            <th>Multi-Agent</th>
                            <th>Raccomandazione</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Task semplici</td>
                            <td><span class="complexity-low">✅ Ottimo</span></td>
                            <td><span class="complexity-high">❌ Overkill</span></td>
                            <td>Usa Templates</td>
                        </tr>
                        <tr>
                            <td>Task complessi</td>
                            <td><span class="complexity-medium">⚠️ Limitato</span></td>
                            <td><span class="complexity-low">✅ Ideale</span></td>
                            <td>Usa Multi-Agent</td>
                        </tr>
                        <tr>
                            <td>Manutenibilità</td>
                            <td><span class="complexity-low">✅ Semplice</span></td>
                            <td><span class="complexity-medium">⚠️ Complessa</span></td>
                            <td>Dipende dal team</td>
                        </tr>
                        <tr>
                            <td>Performance</td>
                            <td><span class="complexity-low">✅ Veloce</span></td>
                            <td><span class="complexity-medium">⚠️ Overhead</span></td>
                            <td>Valuta caso per caso</td>
                        </tr>
                        <tr>
                            <td>Scalabilità</td>
                            <td><span class="complexity-medium">⚠️ Media</span></td>
                            <td><span class="complexity-low">✅ Eccellente</span></td>
                            <td>Multi-Agent per crescita</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                <div style="background: rgba(99, 102, 241, 0.1); padding: 1.5rem; border-radius: 15px;">
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">📝 Quando Usare Templates</h4>
                    <ul style="color: #cbd5e1; padding-left: 1.5rem;">
                        <li>Task con variazioni prevedibili</li>
                        <li>Necessità di controllo fine sul prompt</li>
                        <li>Team piccoli o risorse limitate</li>
                        <li>Prototipazione rapida</li>
                    </ul>
                </div>
                
                <div style="background: rgba(236, 72, 153, 0.1); padding: 1.5rem; border-radius: 15px;">
                    <h4 style="color: var(--secondary); margin-bottom: 1rem;">🤖 Quando Usare Multi-Agent</h4>
                    <ul style="color: #cbd5e1; padding-left: 1.5rem;">
                        <li>Task con molte specializzazioni</li>
                        <li>Necessità di parallelizzazione</li>
                        <li>Sistemi che devono crescere</li>
                        <li>Team enterprise con risorse</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Section 4: State Management -->
        <div class="content-section">
            <h2 class="section-title">
                <div class="section-icon">💾</div>
                State Management nell'Orchestrazione
            </h2>

            <p style="font-size: 1.1rem; margin-bottom: 2rem; color: #cbd5e1;">
                La gestione dello stato è fondamentale per mantenere contesto e coerenza durante l'esecuzione dell'agente.
            </p>

            <div class="state-diagram">
                <h4 style="color: var(--primary); margin-bottom: 2rem;">Pattern di Gestione Stato</h4>
                
                <div class="state-nodes">
                    <div class="state-node" onclick="showStatePattern('memento')">
                        <div class="state-node-icon">📸</div>
                        <div class="state-node-label">Memento</div>
                    </div>
                    
                    <div class="state-node" onclick="showStatePattern('state-machine')">
                        <div class="state-node-icon">🎰</div>
                        <div class="state-node-label">State Machine</div>
                    </div>
                    
                    <div class="state-node" onclick="showStatePattern('event-sourcing')">
                        <div class="state-node-icon">📊</div>
                        <div class="state-node-label">Event Sourcing</div>
                    </div>
                </div>

                <div id="statePatternDetails" style="margin-top: 2rem; padding: 1.5rem; background: rgba(99, 102, 241, 0.1); border-radius: 15px; min-height: 100px;">
                    <p style="color: #94a3b8; text-align: center;">
                        Clicca su un pattern per vedere i dettagli
                    </p>
                </div>
            </div>

            <div style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div style="background: rgba(16, 185, 129, 0.1); padding: 1.5rem; border-radius: 15px; text-align: center;">
                    <h4 style="color: var(--success);">✅ Persistenza</h4>
                    <p style="color: #cbd5e1; font-size: 0.9rem;">Database, Cache, File System</p>
                </div>
                
                <div style="background: rgba(245, 158, 11, 0.1); padding: 1.5rem; border-radius: 15px; text-align: center;">
                    <h4 style="color: var(--warning);">⚡ In-Memory</h4>
                    <p style="color: #cbd5e1; font-size: 0.9rem;">Veloce ma volatile</p>
                </div>
                
                <div style="background: rgba(99, 102, 241, 0.1); padding: 1.5rem; border-radius: 15px; text-align: center;">
                    <h4 style="color: var(--primary);">🔄 Rollback</h4>
                    <p style="color: #cbd5e1; font-size: 0.9rem;">Recovery e undo operations</p>
                </div>
            </div>
        </div>

        <!-- Section 5: Performance e Monitoring -->
        <div class="content-section">
            <h2 class="section-title">
                <div class="section-icon">📊</div>
                Performance e Monitoring
            </h2>

            <p style="font-size: 1.1rem; margin-bottom: 2rem; color: #cbd5e1;">
                Monitorare le performance è essenziale per ottimizzare l'orchestrazione e identificare bottleneck.
            </p>

            <div class="performance-dashboard">
                <h4 style="color: var(--primary); margin-bottom: 2rem; text-align: center;">
                    Dashboard Concettuale delle Metriche
                </h4>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">2.3s</div>
                        <div class="metric-label">Latenza Media</div>
                        <div class="metric-chart">
                            <div class="chart-line"></div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value">95%</div>
                        <div class="metric-label">Success Rate</div>
                        <div class="metric-chart">
                            <div class="chart-line"></div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value">1.2K</div>
                        <div class="metric-label">Tokens/Request</div>
                        <div class="metric-chart">
                            <div class="chart-line"></div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value">8ms</div>
                        <div class="metric-label">Tool Latency</div>
                        <div class="metric-chart">
                            <div class="chart-line"></div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(0, 0, 0, 0.3); border-radius: 15px;">
                    <h4 style="color: var(--accent); margin-bottom: 1rem;">🔍 Bottleneck Identification</h4>
                    <ul style="color: #cbd5e1; padding-left: 1.5rem;">
                        <li><strong>API Calls:</strong> Monitora latenza e rate limits</li>
                        <li><strong>Token Usage:</strong> Ottimizza prompt e risposte</li>
                        <li><strong>Tool Performance:</strong> Identifica tools lenti</li>
                        <li><strong>Memory Usage:</strong> Previeni memory leaks</li>
                    </ul>
                </div>

                <div style="margin-top: 1.5rem; padding: 1.5rem; background: rgba(99, 102, 241, 0.1); border-radius: 15px;">
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">📈 Observability Patterns</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; text-align: center;">
                        <div style="background: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 10px;">
                            <div style="font-size: 2rem;">📝</div>
                            <div style="color: #cbd5e1; font-size: 0.9rem;">Structured Logging</div>
                        </div>
                        <div style="background: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 10px;">
                            <div style="font-size: 2rem;">🔍</div>
                            <div style="color: #cbd5e1; font-size: 0.9rem;">Distributed Tracing</div>
                        </div>
                        <div style="background: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 10px;">
                            <div style="font-size: 2rem;">📊</div>
                            <div style="color: #cbd5e1; font-size: 0.9rem;">Real-time Metrics</div>
                        </div>
                        <div style="background: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 10px;">
                            <div style="font-size: 2rem;">🚨</div>
                            <div style="color: #cbd5e1; font-size: 0.9rem;">Smart Alerting</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lab Visual -->
        <div class="content-section">
            <h2 class="section-title">
                <div class="section-icon">🔬</div>
                LAB: Orchestration Flow Designer
            </h2>

            <p style="font-size: 1.1rem; margin-bottom: 2rem; color: #cbd5e1;">
                Progetta il tuo flusso di orchestrazione trascinando i componenti nel canvas. 
                Nessun codice richiesto - solo logica visuale!
            </p>

            <div class="flow-designer">
                <div class="designer-toolbar">
                    <div class="tool-item" draggable="true" ondragstart="drag(event)" data-component="start">
                        <span style="font-size: 1.5rem;">🚀</span>
                        <span>Start Node</span>
                    </div>
                    <div class="tool-item" draggable="true" ondragstart="drag(event)" data-component="llm">
                        <span style="font-size: 1.5rem;">🧠</span>
                        <span>LLM Call</span>
                    </div>
                    <div class="tool-item" draggable="true" ondragstart="drag(event)" data-component="tool">
                        <span style="font-size: 1.5rem;">🛠️</span>
                        <span>Tool Call</span>
                    </div>
                    <div class="tool-item" draggable="true" ondragstart="drag(event)" data-component="condition">
                        <span style="font-size: 1.5rem;">🔀</span>
                        <span>Condition</span>
                    </div>
                    <div class="tool-item" draggable="true" ondragstart="drag(event)" data-component="end">
                        <span style="font-size: 1.5rem;">🏁</span>
                        <span>End Node</span>
                    </div>
                </div>

                <div class="designer-canvas" ondrop="drop(event)" ondragover="allowDrop(event)" id="canvas">
                    <div class="canvas-placeholder">
                        Trascina qui i componenti per costruire il tuo flusso di orchestrazione
                    </div>
                </div>

                <div style="margin-top: 1.5rem; text-align: center;">
                    <button onclick="exportFlow()" style="background: var(--gradient); color: white; padding: 0.75rem 2rem; border: none; border-radius: 30px; cursor: pointer; font-size: 1rem;">
                        📥 Esporta Diagramma
                    </button>
                    <button onclick="clearCanvas()" style="background: rgba(239, 68, 68, 0.2); color: var(--error); padding: 0.75rem 2rem; border: 1px solid var(--error); border-radius: 30px; cursor: pointer; font-size: 1rem; margin-left: 1rem;">
                        🗑️ Reset Canvas
                    </button>
                </div>
            </div>
        </div>

        <!-- Guide Section -->
        <div class="guide-section">
            <h3>🔬 Implementazione Avanzata</h3>
            <p>Pronto per costruire un sistema di orchestrazione completo?</p>
            <a href="../../guide/research-assistant-orchestration.html" class="guide-btn coming-soon">
                Research Assistant con Orchestrazione →
            </a>
            <p class="guide-note">Coming Soon: Run loops, template system, 
               e monitoring production-ready</p>
        </div>

        <!-- Navigation -->
        <div class="lesson-nav">
            <a href="lezione-3.html" class="nav-btn">
                <span>← Lezione 3</span>
                <div>
                    <strong>Tools e Instructions Avanzate</strong>
                    <p style="font-size: 0.9rem; color: #94a3b8; margin: 0;">Design patterns e orchestrazione</p>
                </div>
            </a>
            <a href="lezione-5.html" class="nav-btn next">
                <div style="text-align: right;">
                    <strong>Multi-Agent Systems</strong>
                    <p style="font-size: 0.9rem; color: #94a3b8; margin: 0;">Sistemi distribuiti e coordinamento</p>
                </div>
                <span>Lezione 5 →</span>
            </a>
        </div>
    </main>

    <script>
        // Run Loop Animation
        let currentState = 0;
        const states = ['ready', 'running', 'waiting', 'complete'];
        
        function animateRunLoop() {
            const stateElements = document.querySelectorAll('.loop-state');
            stateElements.forEach(el => el.classList.remove('active'));
            
            if (currentState < stateElements.length) {
                stateElements[currentState].classList.add('active');
                currentState = (currentState + 1) % states.length;
            }
        }
        
        // Start animation
        setInterval(animateRunLoop, 2000);
        
        // Interactive State Activation
        function activateState(element, state) {
            document.querySelectorAll('.loop-state').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            
            // Show state details
            const details = {
                ready: "Inizializzazione dell'agente con istruzioni e tools",
                running: "Esecuzione attiva di task e chiamate LLM",
                waiting: "Attesa di risposte da tools esterni o user input",
                complete: "Task completato con successo o exit condition raggiunta"
            };
            
            // Could show a modal or update a detail section
            console.log(details[state]);
        }
        
        // Exit Condition Details
        function showExitDetail(type) {
            const details = {
                deterministic: {
                    title: "Exit Conditions Deterministiche",
                    content: "Le condizioni deterministiche garantiscono una terminazione prevedibile basata su eventi specifici come tool calls finali o output strutturati."
                },
                probabilistic: {
                    title: "Exit Conditions Probabilistiche",
                    content: "Basate su metriche di confidence o threshold, permettono terminazione flessibile quando l'agente raggiunge un livello di certezza sufficiente."
                },
                timeout: {
                    title: "Timeout e Limiti",
                    content: "Protezioni essenziali contro loop infiniti, includono limiti di tempo, numero di iterazioni o consumo di risorse."
                },
                error: {
                    title: "Gestione Errori",
                    content: "Terminazione controllata in caso di errori critici, con possibilità di retry policy e graceful degradation."
                }
            };
            
            // Could show in a modal or update a section
            console.log(details[type]);
        }
        
        // Decision Tree Expansion
        function expandDecisionTree() {
            const treeContainer = document.getElementById('decisionTree');
            treeContainer.innerHTML = `
                <div style="padding: 2rem; background: rgba(0, 0, 0, 0.3); border-radius: 15px;">
                    <div style="margin-bottom: 1.5rem;">
                        <strong style="color: var(--primary);">START</strong> → Valuta Response
                    </div>
                    <div style="margin-left: 2rem; margin-bottom: 1rem;">
                        ├─ Tool Call? → Check se finale → EXIT
                    </div>
                    <div style="margin-left: 2rem; margin-bottom: 1rem;">
                        ├─ Direct Response? → No tools needed → EXIT
                    </div>
                    <div style="margin-left: 2rem; margin-bottom: 1rem;">
                        ├─ Error? → Critical? → EXIT / RETRY
                    </div>
                    <div style="margin-left: 2rem;">
                        └─ Max Iterations? → Force EXIT
                    </div>
                </div>
            `;
        }
        
        // State Pattern Details
        function showStatePattern(pattern) {
            const details = {
                memento: {
                    icon: "📸",
                    title: "Memento Pattern",
                    description: "Cattura e ripristina lo stato dell'agente in qualsiasi momento. Ideale per implementare undo/redo e checkpoint durante l'esecuzione."
                },
                'state-machine': {
                    icon: "🎰",
                    title: "State Machine Pattern",
                    description: "Definisce stati discreti e transizioni valide. Perfetto per workflow complessi con regole di business specifiche."
                },
                'event-sourcing': {
                    icon: "📊",
                    title: "Event Sourcing Pattern",
                    description: "Registra ogni evento come immutabile. Permette replay completo dell'esecuzione e audit trail dettagliato."
                }
            };
            
            const detailsDiv = document.getElementById('statePatternDetails');
            const detail = details[pattern];
            
            detailsDiv.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">${detail.icon}</div>
                    <h4 style="color: var(--primary); margin-bottom: 1rem;">${detail.title}</h4>
                    <p style="color: #cbd5e1;">${detail.description}</p>
                </div>
            `;
        }
        
        // Drag and Drop for Flow Designer
        function allowDrop(ev) {
            ev.preventDefault();
        }
        
        function drag(ev) {
            ev.dataTransfer.setData("component", ev.target.getAttribute('data-component'));
        }
        
        function drop(ev) {
            ev.preventDefault();
            const component = ev.dataTransfer.getData("component");
            const canvas = document.getElementById('canvas');
            
            // Remove placeholder if exists
            const placeholder = canvas.querySelector('.canvas-placeholder');
            if (placeholder) {
                placeholder.remove();
            }
            
            // Create component element
            const componentEl = document.createElement('div');
            componentEl.className = 'dropped-component';
            
            const icons = {
                start: '🚀 Start',
                llm: '🧠 LLM Call',
                tool: '🛠️ Tool Call',
                condition: '🔀 Condition',
                end: '🏁 End'
            };
            
            componentEl.textContent = icons[component] || component;
            canvas.appendChild(componentEl);
        }
        
        function clearCanvas() {
            const canvas = document.getElementById('canvas');
            canvas.innerHTML = `
                <div class="canvas-placeholder">
                    Trascina qui i componenti per costruire il tuo flusso di orchestrazione
                </div>
            `;
        }
        
        function exportFlow() {
            const canvas = document.getElementById('canvas');
            const components = canvas.querySelectorAll('.dropped-component');
            
            if (components.length === 0) {
                alert('Aggiungi almeno un componente prima di esportare!');
                return;
            }
            
            let flow = "Flusso di Orchestrazione:\n";
            components.forEach((comp, index) => {
                flow += `${index + 1}. ${comp.textContent}\n`;
            });
            
            // In a real app, this would generate a proper diagram
            console.log(flow);
            alert('Diagramma esportato! (Check console)');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Start animations
            animateRunLoop();
            
            // Add smooth scroll
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
        });
    </script>
</body>
</html>